# cloudbuild.yaml â”€ revised

steps:
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1) BUILD & PUSH IMAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- id: build-image
  name: gcr.io/cloud-builders/docker
  args:
    - build
    - '--tag=us-central1-docker.pkg.dev/${PROJECT_ID}/restaurant-app/restaurant-app:${SHORT_SHA}'
    - '--tag=us-central1-docker.pkg.dev/${PROJECT_ID}/restaurant-app/restaurant-app:latest'
    - '.'

- id: push-sha-image
  name: gcr.io/cloud-builders/docker
  args: ['push','us-central1-docker.pkg.dev/${PROJECT_ID}/restaurant-app/restaurant-app:${SHORT_SHA}']
  waitFor: ['build-image']

- id: push-latest-image
  name: gcr.io/cloud-builders/docker
  args: ['push','us-central1-docker.pkg.dev/${PROJECT_ID}/restaurant-app/restaurant-app:latest']
  waitFor: ['build-image']

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2) DEPLOY TO CLOUD RUN (only _prod_) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#- id: deploy-to-cloud-run
#  name: gcr.io/cloud-builders/gcloud
#  entrypoint: bash
#  args:
#    - -c
#    - |
#      if [[ "$_TARGET_ENV" == "prod" ]]; then
#        echo "ğŸ”„ Deploying to Cloud Run (prod)â€¦"
#        gcloud run deploy restaurant-app \
#          --image=us-central1-docker.pkg.dev/$PROJECT_ID/restaurant-app/restaurant-app:latest \
#          --revision-suffix=sha-${SHORT_SHA} \
#          --region=us-central1 \
#          --platform=managed \
#          --allow-unauthenticated \
#          --project=${PROJECT_ID}
#      else
#        echo "Skipping Cloud Run deployment â€“ _TARGET_ENV=${_TARGET_ENV}"
#      fi
#  waitFor: ['push-latest-image']

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3) OPTIONAL 10 % CANARY SPLIT (only _prod_) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#- id: canary-split-cloud-run
#  name: gcr.io/cloud-builders/gcloud
#  entrypoint: bash
#  args:
#    - -c
#    - |
#      if [[ "$_TARGET_ENV" == "prod" ]]; then
#        echo "ğŸ” Fetching revisions for canary splitâ€¦"
#        revs=$(gcloud run revisions list \
#                 --service=restaurant-app \
#                 --region=us-central1 \
#                 --platform=managed \
#                 --sort-by="~metadata.creationTimestamp" \
#                 --limit=2 \
#                 --format="value(metadata.name)" \
#                 --project=${PROJECT_ID}) || exit 0
#        readarray -t arr <<< "$revs"
#        new="${arr[0]}"
#        prev="${arr[1]:-}"
#        [[ -z "$new" ]] && { echo "No revision found â€“ skipping"; exit 0; }
#       if [[ -n "$prev" ]]; then
#          echo "ğŸª„ 10 % â†’ $new, 90 % â†’ $prev"
#          gcloud run services update-traffic restaurant-app \
#            --region=us-central1 --platform=managed \
#            --to-revisions="$new=10,$prev=90" \
#            --project=${PROJECT_ID}
#        else
#          echo "Single revision â€“ 100 % traffic on $new"
#        fi
#      else
#        echo "Skipping canary â€“ _TARGET_ENV=${_TARGET_ENV}"
#      fi
#  waitFor: ['deploy-to-cloud-run']

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4) OPTIONAL DEBUG STEP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- id: debug-file-listing
  name: gcr.io/google.com/cloudsdktool/cloud-sdk:slim
  entrypoint: bash
  args:
    - -c
    - |
      echo "--- $(pwd) ---"; ls -la
      echo "--- ./charts ---"; ls -la ./charts || true
      echo "--- ./charts/restaurant-app ---"; ls -la ./charts/restaurant-app || true
  waitFor: ['push-sha-image']

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 5) TERRAFORM â€“ DEPLOY STAGING GKE (prod only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: hashicorp/terraform:1.5.7
  id: Terraform Deploy Staging GKE
  dir: infra
  entrypoint: sh
  args:
    - -c
    - |
      if [[ "$_TARGET_ENV" == "prod" ]]; then
        echo "â–¶ï¸  Terraform: helm_release.staging (${SHORT_SHA})"
        terraform init
        terraform apply -auto-approve \
          -var="image_tag=${SHORT_SHA}" \
          -target=helm_release.staging
      else
        echo "Skipping staging deploy â€“ _TARGET_ENV=${_TARGET_ENV}"
      fi
  waitFor: ['push-sha-image','debug-file-listing']

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 6) MANUAL APPROVAL GATE (prod only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: gcr.io/cloud-builders/gcloud
  id: Hold for Production Approval
  entrypoint: bash
  args:
    - -c
    - |
      if [[ "$_TARGET_ENV" == "prod" ]]; then
        echo "WAITING FOR MANUAL APPROVAL"
      else
        echo "Approval step not needed"
      fi
  waitFor: ['Terraform Deploy Staging GKE']

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 7) TERRAFORM â€“ DEPLOY PROD GKE (prod only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: hashicorp/terraform:1.5.7
  id: Terraform Deploy Production GKE
  dir: infra
  entrypoint: sh
  args:
    - -c
    - |
      if [[ "$_TARGET_ENV" == "prod" ]]; then
        echo "â–¶ï¸  Terraform: helm_release.production (${SHORT_SHA})"
        terraform init
        terraform apply -auto-approve \
          -var="image_tag=${SHORT_SHA}" \
          -target=helm_release.production
      else
        echo "Skipping prod deploy â€“ _TARGET_ENV=${_TARGET_ENV}"
      fi
  waitFor: ['Hold for Production Approval']

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ OPTIONS / SUBSTITUTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
options:
  logging: CLOUD_LOGGING_ONLY   # keep build logs in Cloud Logging

